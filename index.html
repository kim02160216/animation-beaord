<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novelpia Animation - Integrated Real-time Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <style>
        :root { --bg-color: #0f172a; --surface-color: #1e293b; --primary-accent: #6366f1; --text-main: #f8fafc; --text-muted: #cbd5e1; --border-color: rgba(255, 255, 255, 0.12); }
        body { background-color: var(--bg-color); color: var(--text-main); font-family: 'Pretendard', sans-serif; }
        .wrapper { display: flex; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--surface-color); border-right: 1px solid var(--border-color); padding: 24px; flex-shrink: 0; }
        .main-content { flex: 1; padding: 32px; overflow-x: hidden; }
        .glass-card { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; height: 100%; }
        .panel-date-picker { background: rgba(0,0,0,0.4); border: 1px solid var(--primary-accent); border-radius: 6px; display: flex; align-items: center; padding: 0 8px; height: 34px; }
        .panel-date-picker input[type="date"] { font-size: 0.85rem; background: transparent; border: none; color: white; color-scheme: dark; outline: none; font-weight: bold;}
        .mkt-box { background: rgba(0,0,0,0.3); border-radius: 8px; padding: 15px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .mkt-title { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 5px; }
        .mkt-value { font-size: 1.5rem; font-weight: 700; }
        .looker-table { width: 100%; font-size: 0.85rem; color: #e2e8f0; }
        .looker-table th { background: rgba(255,255,255,0.05); padding: 12px; border-bottom: 2px solid var(--border-color); font-weight: bold;}
        .looker-table td { padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .view-bar-container { display: flex; align-items: center; gap: 8px; }
        .bar { height: 8px; border-radius: 2px; min-width: 2px; }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(15,23,42,0.9); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .text-muted { color: var(--text-muted) !important; }
        
        /* 모달 및 공정카드 스타일 축약 */
        .modal-content { background-color: var(--surface-color); border: 1px solid rgba(255,255,255,0.2); color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        .modal-header { border-bottom: 1px solid var(--border-color); padding: 20px 24px;}
        .modal-footer { border-top: 1px solid var(--border-color); padding: 16px 24px;}
        .form-control, .form-select { background-color: rgba(255,255,255,0.05) !important; color: #ffffff !important; border: 1px solid rgba(255,255,255,0.2) !important; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-accent) !important; box-shadow: 0 0 0 0.25rem rgba(99,102,241,0.25) !important; }
        .process-steps { display: flex; gap: 8px; margin-top: 12px; margin-bottom: 16px; }
        .step-badge { flex: 1; text-align: center; padding: 6px 0; border-radius: 6px; font-size: 0.75rem; font-weight: 600; border: 1px solid var(--border-color); background: rgba(0,0,0,0.3); color: #e2e8f0; }
        .step-badge.done { background: rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.4); color: #34d399; }
        .step-badge.ing { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.4); color: #818cf8; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; font-size: 0.85rem; }
        .info-item { background: rgba(0,0,0,0.25); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); }
        .info-item.full-width { grid-column: span 2; background: rgba(99,102,241,0.15); border-color: rgba(99,102,241,0.3); }
        .info-label { color: #e2e8f0; display: block; margin-bottom: 6px; font-size: 0.8rem; font-weight: 500; } 
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
    <h5 class="fw-bold text-white">Google Sheets 원본 데이터 로딩 중...</h5>
    <p class="text-muted small">플랫폼 로우 데이터 매핑을 진행합니다.</p>
</div>

<div class="wrapper">
    <aside class="sidebar d-none d-xl-block">
        <div class="fw-bold fs-4 mb-5 text-white">NOVELPIA<span class="text-primary">.</span></div>
        <nav class="nav flex-column gap-2">
            <a class="nav-link text-white bg-primary rounded shadow-sm" href="#"><i class="fas fa-chart-pie me-2"></i> 성과 대시보드</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold mb-0 text-white">실시간 제작 및 성과 분석</h2>
                <p class="text-muted small mb-0">Google Sheets DB Connect: <span class="text-success fw-bold">Live</span></p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                <div class="panel-date-picker bg-primary bg-opacity-10">
                    <span class="small fw-bold text-primary me-2">전역 설정</span>
                    <input type="date" id="globalStart" class="global-date" value="2026-01-08">
                    <span class="mx-1 text-white">~</span>
                    <input type="date" id="globalEnd" class="global-date" value="2026-01-15">
                </div>
                <button class="btn btn-primary fw-bold px-3" onclick="fetchSheetData()"><i class="fas fa-sync-alt me-1"></i>DB 동기화</button>
                <button class="btn btn-outline-light fw-bold px-3" data-bs-toggle="modal" data-bs-target="#manualInputModal"><i class="fas fa-sliders-h me-1"></i>수동 관리 패널</button>
            </div>
        </header>

        <div class="row g-4 mb-4">
            <div class="col-xl-7">
                <div class="glass-card d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3" style="border-color: rgba(255,255,255,0.1) !important;">
                        <h5 class="fw-bold mb-0 text-white"><i class="fas fa-chart-line text-primary me-2"></i>제작 성과 트렌드</h5>
                        <div class="panel-date-picker">
                            <input type="date" id="trendStart" class="local-date" value="2026-01-08">
                            <span class="mx-1 text-white">~</span>
                            <input type="date" id="trendEnd" class="local-date" value="2026-01-15">
                        </div>
                    </div>
                    <div style="height: 300px; width: 100%;"><canvas id="performanceChart"></canvas></div>
                </div>
            </div>
            
            <div class="col-xl-5">
                <div class="glass-card d-flex flex-column">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3" style="border-color: rgba(255,255,255,0.1) !important;">
                        <h5 class="fw-bold mb-0 text-white"><i class="fas fa-bullhorn text-warning me-2"></i>마케팅 데이터</h5>
                        <div class="panel-date-picker">
                            <input type="date" id="mktStart" class="local-date" value="2026-01-08">
                            <span class="mx-1 text-white">~</span>
                            <input type="date" id="mktEnd" class="local-date" value="2026-01-15">
                        </div>
                    </div>
                    <div class="row g-2 mb-4">
                        <div class="col-6"><div class="mkt-box"><div class="mkt-title">광고비 합계</div><div class="mkt-value text-white">0</div></div></div>
                        <div class="col-6"><div class="mkt-box"><div class="mkt-title">가입수 합계</div><div class="mkt-value text-success">0</div></div></div>
                    </div>
                    <div class="flex-grow-1 text-center">
                        <h6 class="text-white fw-bold mb-3 small">작품별 광고 볼륨 비중</h6>
                        <div style="height: 180px; width: 100%;"><canvas id="pieChartProject"></canvas></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass-card mb-4 border-top-0" style="border-top: 4px solid #4285F4 !important;">
            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3" style="border-color: rgba(255,255,255,0.1) !important;">
                <h5 class="fw-bold mb-0 text-white"><i class="fas fa-database me-2" style="color:#4285F4;"></i>Animation Platform Data (로우 데이터 기반 실시간 맵핑)</h5>
                <div class="panel-date-picker">
                    <input type="date" id="platStart" class="local-date" value="2026-01-08">
                    <span class="mx-1 text-white">~</span>
                    <input type="date" id="platEnd" class="local-date" value="2026-01-15">
                </div>
            </div>
            <div class="table-responsive">
                <table class="looker-table">
                    <thead>
                        <tr>
                            <th style="width: 35%;">소설 명 (F열)</th>
                            <th style="width: 20%;" class="text-end">회원 조회수 (C열)</th>
                            <th style="width: 20%;" class="text-end">비회원 조회수 (D열)</th>
                            <th style="width: 25%;" class="text-end">총 조회수 (E열)</th>
                        </tr>
                    </thead>
                    <tbody id="platformDataTbody">
                        </tbody>
                </table>
            </div>
        </div>

    </main>
</div>

<script>
    // 본부장님이 제공해주신 가장 확실한 웹게시 CSV 링크
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlR--jYpab01qH_mN4iKPboMJXtqjBPas_KXQrxOUC2FjIRtPgFCbU1RTWbSb7YelYPRh-3_BzJWMo/pub?gid=22579142&single=true&output=csv';
    
    let globalRawData = [];
    let perfChart, projectPieChart;

    document.addEventListener('DOMContentLoaded', () => {
        // 차트 초기화 (트렌드는 총 조회수 기준)
        Chart.defaults.color = '#ffffff'; 
        Chart.defaults.font.family = 'Pretendard';
        perfChart = new Chart(document.getElementById('performanceChart').getContext('2d'), {
            type: 'line', data: { labels: [], datasets: [] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: '#ffffff' } } }, scales: { x: { ticks: { color: '#e2e8f0' } }, y: { ticks: { color: '#e2e8f0' } } } }
        });
        projectPieChart = new Chart(document.getElementById('pieChartProject').getContext('2d'), { 
            type: 'pie', data: { labels: ['데이터 없음'], datasets: [{ data: [1], backgroundColor: ['#333'] }] }, options: { responsive: true, maintainAspectRatio: false } 
        });

        // 날짜 연동
        document.querySelectorAll('.global-date').forEach(el => el.addEventListener('change', syncDates));
        document.querySelectorAll('.local-date').forEach(el => el.addEventListener('change', renderData));

        fetchSheetData();
    });

    function syncDates() {
        const gs = document.getElementById('globalStart').value;
        const ge = document.getElementById('globalEnd').value;
        document.getElementById('trendStart').value = gs; document.getElementById('trendEnd').value = ge;
        document.getElementById('mktStart').value = gs; document.getElementById('mktEnd').value = ge;
        document.getElementById('platStart').value = gs; document.getElementById('platEnd').value = ge;
        renderData();
    }

    function fetchSheetData() {
        document.getElementById('loadingOverlay').style.display = 'flex';
        
        Papa.parse(CSV_URL, {
            download: true,
            header: false, // 열 인덱스(0, 1, 2...)로 매핑하기 위해 false
            skipEmptyLines: true,
            complete: function(results) {
                document.getElementById('loadingOverlay').style.display = 'none';
                globalRawData = results.data;
                console.log("시트 원본 데이터 로드 성공:", globalRawData.length, "줄");
                renderData();
            },
            error: function(err) {
                document.getElementById('loadingOverlay').style.display = 'none';
                alert("구글 시트를 읽어오는데 실패했습니다. URL을 확인해 주세요.");
                console.error(err);
            }
        });
    }

    // 문자열을 안전한 숫자로 변환
    function sNum(v) { 
        if(!v) return 0;
        let p = parseFloat(String(v).replace(/,/g, '')); 
        return isNaN(p) ? 0 : p; 
    }
    
    // 날짜 문자열 변환기 (2026-01-08 포맷 보장)
    function sDate(v) { 
        if(!v) return null;
        let c = String(v).replace(/\./g, '-').replace(/\//g, '-').replace(/\s/g, '').trim();
        if(c.endsWith('-')) c = c.slice(0, -1);
        let d = new Date(c);
        return isNaN(d.getTime()) ? null : d;
    }

    function renderData() {
        if (!globalRawData || globalRawData.length < 2) return;

        const ts = new Date(document.getElementById('trendStart').value); const te = new Date(document.getElementById('trendEnd').value + 'T23:59:59');
        const ps = new Date(document.getElementById('platStart').value); const pe = new Date(document.getElementById('platEnd').value + 'T23:59:59');

        let tMap = {}, platMap = {};

        // 1번째 줄(헤더) 제외하고 데이터 순회
        for(let i=1; i<globalRawData.length; i++) {
            let row = globalRawData[i];
            
            // F열(소설명)까지 데이터가 있어야 함 (index 5)
            if(row.length < 6) continue; 

            // A열 (인덱스 0): 날짜
            let dObj = sDate(row[0]);
            if(!dObj) continue;

            // F열 (인덱스 5): 소설명
            let name = row[5] ? String(row[5]).trim() : '알 수 없음';
            
            // C열(회원), D열(비회원), E열(총 조회수) 매핑!
            let rMem = sNum(row[2]); 
            let rNon = sNum(row[3]); 
            let rTot = sNum(row[4]); 

            // ★ 플랫폼 데이터 필터링 ★
            if (dObj >= ps && dObj <= pe) {
                if(name !== '') {
                    if(!platMap[name]) platMap[name] = {m:0, nm:0, tot:0};
                    platMap[name].m += rMem;
                    platMap[name].nm += rNon;
                    platMap[name].tot += rTot;
                }
            }

            // 트렌드 차트 필터링 (총 조회수 합산)
            if (dObj >= ts && dObj <= te) {
                let k = new Date(dObj.getTime() - (dObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                if(!tMap[k]) tMap[k] = 0;
                tMap[k] += rTot;
            }
        }

        // --- 1. 플랫폼 데이터 UI 업데이트 (가장 중요) ---
        const tbody = document.getElementById('platformDataTbody');
        tbody.innerHTML = '';
        
        let pArr = Object.keys(platMap).map(k => ({name:k, ...platMap[k]}));
        // 총 조회수 기준 내림차순 정렬
        pArr.sort((a,b) => b.tot - a.tot); 
        
        if(pArr.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-5 text-muted">선택된 날짜 기간에 해당하는 데이터가 없습니다. 상단 날짜를 변경해 보세요.</td></tr>';
        } else {
            let mTot = Math.max(...pArr.map(d=>d.tot), 1);
            pArr.forEach(d => {
                let mPct=(d.m/mTot)*100, nmPct=(d.nm/mTot)*100, tPct=(d.tot/mTot)*100;
                tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td class="fw-bold">${d.name}</td>
                    <td>
                        <div class="view-bar-container justify-content-start">
                            <span class="view-text text-start" style="width:55px;">${d.m.toLocaleString()}</span>
                            <div class="bar-blue" style="width:${mPct}%; background-color:#4285F4; height:8px;"></div>
                        </div>
                    </td>
                    <td>
                        <div class="view-bar-container justify-content-start">
                            <span class="view-text text-start" style="width:55px;">${d.nm.toLocaleString()}</span>
                            <div class="bar-orange" style="width:${nmPct}%; background-color:#F4B400; height:8px;"></div>
                        </div>
                    </td>
                    <td>
                        <div class="view-bar-container justify-content-start">
                            <span class="view-text text-start text-info" style="width:60px;">${d.tot.toLocaleString()}</span>
                            <div class="bar-purple" style="width:${tPct}%; background-color:#A142F4; height:8px;"></div>
                        </div>
                    </td>
                </tr>`);
            });
        }

        // --- 2. 트렌드 차트 UI 업데이트 ---
        let dates = Object.keys(tMap).sort();
        perfChart.data.labels = dates;
        perfChart.data.datasets[0] = { label: '총 조회수 추이', data: dates.map(d=>tMap[d]), borderColor: '#818cf8', backgroundColor: 'rgba(129,140,248,0.2)', borderWidth: 3, tension: 0.4, fill: true };
        perfChart.update();
    }
</script>
</body>
</html>
